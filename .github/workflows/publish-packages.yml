name: Publish Packages

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Build multi-platform binaries
        run: |
          mkdir -p release
          
          # Build for multiple platforms (fixed: removed /main.go suffix)
          GOOS=linux GOARCH=amd64 go build -o release/contextlite-linux-amd64 ./cmd/contextlite
          GOOS=linux GOARCH=arm64 go build -o release/contextlite-linux-arm64 ./cmd/contextlite
          GOOS=darwin GOARCH=amd64 go build -o release/contextlite-darwin-amd64 ./cmd/contextlite
          GOOS=darwin GOARCH=arm64 go build -o release/contextlite-darwin-arm64 ./cmd/contextlite
          GOOS=windows GOARCH=amd64 go build -o release/contextlite-windows-amd64.exe ./cmd/contextlite
          GOOS=windows GOARCH=arm64 go build -o release/contextlite-windows-arm64.exe ./cmd/contextlite

      - name: Create release archives
        run: |
          cd release
          
          # Create tar.gz for Unix platforms with clean binary names
          cp contextlite-linux-amd64 contextlite && tar -czf contextlite-${{ steps.version.outputs.version }}-linux-amd64.tar.gz contextlite && rm contextlite
          cp contextlite-linux-arm64 contextlite && tar -czf contextlite-${{ steps.version.outputs.version }}-linux-arm64.tar.gz contextlite && rm contextlite
          cp contextlite-darwin-amd64 contextlite && tar -czf contextlite-${{ steps.version.outputs.version }}-darwin-amd64.tar.gz contextlite && rm contextlite
          cp contextlite-darwin-arm64 contextlite && tar -czf contextlite-${{ steps.version.outputs.version }}-darwin-arm64.tar.gz contextlite && rm contextlite
          
          # Create zip for Windows with clean binary names
          cp contextlite-windows-amd64.exe contextlite.exe && zip contextlite-${{ steps.version.outputs.version }}-windows-amd64.zip contextlite.exe && rm contextlite.exe
          cp contextlite-windows-arm64.exe contextlite.exe && zip contextlite-${{ steps.version.outputs.version }}-windows-arm64.zip contextlite.exe && rm contextlite.exe

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: ContextLite ${{ steps.version.outputs.version }}
          body: |
            **Alpha Testing Release**
            
            Complete marketplace automation with version compliance for ContextLite ${{ steps.version.outputs.version }}.
            
            **Features:**
            - 14-day trial system with full SMT optimization
            - Multi-platform support (Linux, macOS, Windows)
            - Hardware-bound licensing with graceful expiration
            - Real-time statistics and performance metrics
            
            **WARNING: Pre-production release for integration testing only**
            
            **Installation:**
            - Download the appropriate binary for your platform
            - Extract and run `./contextlite --version` to verify
            - Run `./contextlite` to start 14-day trial
            
            **Package Managers:** Available on npm, PyPI, Docker Hub, and more.
          draft: false
          prerelease: true
          files: |
            release/*.tar.gz
            release/*.zip

      - name: Trigger website update
        if: success()
        run: |
          echo "Release ${{ steps.version.outputs.version }} published successfully!"
          echo "The download page will automatically update with new release assets."
          echo "Release URL: https://github.com/Michael-A-Kuykendall/contextlite/releases/tag/v${{ steps.version.outputs.version }}"
          
          # Optional: Send webhook to trigger website rebuild if needed
          # curl -X POST "${{ secrets.WEBSITE_WEBHOOK_URL }}" \
          #   -H "Content-Type: application/json" \
          #   -d '{"version": "${{ steps.version.outputs.version }}", "event": "release_published"}'

  publish-npm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Check if npm package exists
        id: check_npm
        run: |
          if npm view contextlite@${{ steps.version.outputs.version }} >/dev/null 2>&1; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… npm package already exists, skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ npm package not found, proceeding"
          fi

      - name: Create npm package structure
        if: steps.check_npm.outputs.skip == 'false'
        run: |
          # Use existing npm-wrapper
          cp -r npm-wrapper npm-package

      - name: Update npm package version
        if: steps.check_npm.outputs.skip == 'false'
        run: |
          cd npm-package
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - name: Install npm dependencies
        if: steps.check_npm.outputs.skip == 'false'
        run: |
          cd npm-package
          npm install

      - name: Build npm package
        if: steps.check_npm.outputs.skip == 'false'
        run: |
          cd npm-package
          npm run build

      - name: Publish to npm
        if: steps.check_npm.outputs.skip == 'false'
        run: |
          cd npm-package
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-pypi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine wheel

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Check if PyPI package exists
        id: check_pypi
        run: |
          if curl -f "https://pypi.org/pypi/contextlite/${{ steps.version.outputs.version }}/json" >/dev/null 2>&1; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… PyPI package already exists, skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ PyPI package not found, proceeding"
          fi

      - name: Use existing Python package structure
        if: steps.check_pypi.outputs.skip == 'false'
        run: |
          # Use existing python-wrapper
          cp -r python-wrapper python-package

      - name: Update Python package version
        if: steps.check_pypi.outputs.skip == 'false'
        run: |
          cd python-package
          # Update version in pyproject.toml
          sed -i 's/version = ".*"/version = "${{ steps.version.outputs.version }}"/' pyproject.toml

      - name: Build Python package
        if: steps.check_pypi.outputs.skip == 'false'
        run: |
          cd python-package
          python -m build

      - name: Publish to PyPI
        if: steps.check_pypi.outputs.skip == 'false'
        run: |
          cd python-package
          python -m twine upload dist/* --verbose
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  publish-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Build multi-platform binary for Docker
        run: |
          mkdir -p docker-build
          GOOS=linux GOARCH=amd64 go build -o docker-build/contextlite-amd64 ./cmd/contextlite
          GOOS=linux GOARCH=arm64 go build -o docker-build/contextlite-arm64 ./cmd/contextlite

      - name: Create multi-arch Dockerfile
        run: |
          cat > docker-build/Dockerfile << 'EOF'
          FROM --platform=$BUILDPLATFORM alpine:latest AS builder
          ARG TARGETARCH
          COPY contextlite-${TARGETARCH} /usr/local/bin/contextlite
          RUN chmod +x /usr/local/bin/contextlite

          FROM gcr.io/distroless/static:nonroot
          COPY --from=builder /usr/local/bin/contextlite /usr/local/bin/contextlite
          USER nonroot
          EXPOSE 8080
          ENTRYPOINT ["/usr/local/bin/contextlite"]
          CMD ["--help"]
          EOF

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: docker-build
          file: docker-build/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            makuykendall/contextlite:latest
            makuykendall/contextlite:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # DISABLED: Chocolatey requires manual moderation - commented out to avoid build failures
  # publish-chocolatey:
  #   #   runs-on: windows-latest
  #   #   steps:
  #       - name: Checkout
  #         uses: actions/checkout@v4
  # 
  #       - name: Get version
  #         id: version
  #         shell: bash
  #         run: |
  #           if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
  #             echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
  #           else
  #             echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
  #           fi
  # 
  #       - name: Check if Chocolatey package exists
  #         id: check_chocolatey
  #         shell: bash
  #         run: |
  #           if curl -f "https://community.chocolatey.org/api/v2/Packages?%24filter=Id%20eq%20%27contextlite%27%20and%20Version%20eq%20%27${{ steps.version.outputs.version }}%27" >/dev/null 2>&1; then
  #             echo "skip=true" >> $GITHUB_OUTPUT
  #             echo "âœ… Chocolatey package already exists, skipping"
  #           else
  #             echo "skip=false" >> $GITHUB_OUTPUT
  #             echo "ðŸš€ Chocolatey package not found, proceeding"
  #           fi
  # 
  #       - name: Install Chocolatey
  #         if: steps.check_chocolatey.outputs.skip == 'false'
  #         run: |
  #           Set-ExecutionPolicy Bypass -Scope Process -Force
  #           [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
  #           iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
  # 
  #       - name: Use existing Chocolatey package
  #         if: steps.check_chocolatey.outputs.skip == 'false'
  #         shell: powershell
  #         run: |
  #           # Use existing chocolatey package structure
  #           Copy-Item -Path "chocolatey" -Destination "chocolatey-package" -Recurse
  #           
  #           # Update version in nuspec file
  #           cd chocolatey-package
  #           $version = "${{ steps.version.outputs.version }}"
  #           $content = Get-Content "contextlite.nuspec" -Raw
  #           $content = $content -replace 'VERSION_PLACEHOLDER', $version
  #           $content = $content -replace 'releases/tag/VERSION_PLACEHOLDER', "releases/tag/v$version"
  #           Set-Content "contextlite.nuspec" -Value $content
  #           
  #           # Download the Windows binary to get checksum
  #           $downloadUrl = "https://github.com/Michael-A-Kuykendall/contextlite/releases/download/v$version/contextlite-$version-windows-amd64.zip"
  #           Write-Host "Downloading from: $downloadUrl"
  #           Invoke-WebRequest -Uri $downloadUrl -OutFile "contextlite-windows.zip"
  #           $checksum = (Get-FileHash "contextlite-windows.zip" -Algorithm SHA256).Hash
  #           Write-Host "Calculated checksum: $checksum"
  #           
  #           # Update install script with new URL and checksum
  #           $installScript = Get-Content "tools\chocolateyinstall.ps1" -Raw
  #           $installScript = $installScript -replace 'RELEASE_URL_PLACEHOLDER', $downloadUrl
  #           $installScript = $installScript -replace 'RELEASE_CHECKSUM_PLACEHOLDER', $checksum
  #           Set-Content "tools\chocolateyinstall.ps1" -Value $installScript
  #           
  #           Write-Host "Updated Chocolatey package files for version $version"
  # 
  #       - name: Build Chocolatey package
  #         if: steps.check_chocolatey.outputs.skip == 'false'
  #         shell: powershell
  #         run: |
  #           cd chocolatey-package
  #           choco pack
  # 
  #       - name: Publish to Chocolatey
  #         if: steps.check_chocolatey.outputs.skip == 'false'
  #         shell: powershell
  #         run: |
  #           if ($env:CHOCOLATEY_API_KEY) {
  #             cd chocolatey-package
  #             choco push contextlite.${{ steps.version.outputs.version }}.nupkg --source="https://push.chocolatey.org/" --key $env:CHOCOLATEY_API_KEY
  #           } else {
  #             Write-Host "CHOCOLATEY_API_KEY not set, skipping Chocolatey publish"
  #           }
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}

  publish-crates:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Check if Crates version exists
        id: check_crates
        run: |
          if curl -f "https://crates.io/api/v1/crates/contextlite-client" | grep -q "\"${{ steps.version.outputs.version }}\"" 2>/dev/null; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… Crates.io already has this version, skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ Crates.io version not found, proceeding"
          fi

      - name: Update Cargo.toml version
        if: steps.check_crates.outputs.skip == 'false'
        run: |
          cd adapters/rust/contextlite-client
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.version }}"/' Cargo.toml

      - name: Clean and prepare for publishing
        if: steps.check_crates.outputs.skip == 'false'
        run: |
          cd adapters/rust/contextlite-client
          # Clean any previous builds and artifacts
          cargo clean
          rm -f *.exe *.pdb *.rlib test_types.* types.rs
          
          # Verify package contents and size
          echo "ðŸ“¦ Checking package contents..."
          cargo package --list
          
          echo "ðŸ“Š Checking package size..."
          cargo package --no-verify
          ls -lah target/package/*.crate
          
          # Verify size is under 10MB limit
          CRATE_SIZE=$(stat -c%s target/package/*.crate 2>/dev/null || stat -f%z target/package/*.crate)
          MAX_SIZE=10485760  # 10MB in bytes
          if [ "$CRATE_SIZE" -gt "$MAX_SIZE" ]; then
            echo "âŒ Error: Package size $CRATE_SIZE bytes exceeds 10MB limit"
            exit 1
          else
            echo "âœ… Package size $CRATE_SIZE bytes is within 10MB limit"
          fi

      - name: Build for publishing
        if: steps.check_crates.outputs.skip == 'false'
        run: |
          cd adapters/rust/contextlite-client
          cargo build --release
          # Skip all tests during CI publish since integration tests require running server
          echo "Build successful, skipping tests for publishing"

      - name: Publish to crates.io
        if: steps.check_crates.outputs.skip == 'false'
        run: |
          if [ -n "$CARGO_REGISTRY_TOKEN" ]; then
            cd adapters/rust/contextlite-client
            # Publish the already-packaged crate to avoid re-packaging
            cargo publish --token $CARGO_REGISTRY_TOKEN --no-verify
          else
            echo "CARGO_REGISTRY_TOKEN not set, skipping crates.io publish"
          fi
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # publish-vscode:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
  #
  #     - name: Get version
  #       id: version
  #       run: |
  #         if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
  #           echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
  #         else
  #           echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
  #         fi
  #
  #     - name: Install vsce
  #       run: npm install -g @vscode/vsce
  #
  #     - name: Update extension version
  #       run: |
  #         cd vscode-extension
  #         npm version ${{ steps.version.outputs.version }} --no-git-tag-version
  #
  #     - name: Install extension dependencies
  #       run: |
  #         cd vscode-extension
  #         npm install
  #
  #     - name: Compile extension
  #       run: |
  #         cd vscode-extension
  #         npm run compile
  #
  #     - name: Package extension
  #       run: |
  #         cd vscode-extension
  #         vsce package
  #
  #     - name: Publish to VS Code Marketplace
  #       run: |
  #         cd vscode-extension
  #         vsce publish --pat ${{ secrets.VSCODE_MARKETPLACE_TOKEN }}
  #       env:
  #         VSCE_PAT: ${{ secrets.VSCODE_MARKETPLACE_TOKEN }}

  publish-snap:
    runs-on: ubuntu-latest
    needs: build-and-release  # Wait for release to be created
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install snapcraft
        run: sudo snap install snapcraft --classic

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Check if Snap version exists
        id: check_snap
        run: |
          if snap info contextlite | grep -q "${{ steps.version.outputs.version }}" 2>/dev/null; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… Snap Store already has this version, skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ Snap Store version not found, proceeding"
          fi

      - name: Update snapcraft.yaml version
        if: steps.check_snap.outputs.skip == 'false'
        run: |
          # Update the version in our existing snapcraft.yaml 
          sed -i "s/version: git/version: '${{ steps.version.outputs.version }}'/" snap/snapcraft.yaml
          echo "Updated snap/snapcraft.yaml version to ${{ steps.version.outputs.version }}"
          cat snap/snapcraft.yaml

      - name: Build snap
        if: steps.check_snap.outputs.skip == 'false'
        run: snapcraft --destructive-mode

      - name: Login to Snap Store
        if: steps.check_snap.outputs.skip == 'false'
        run: |
          echo "$SNAPCRAFT_STORE_CREDENTIALS" | base64 -d > /tmp/snapcraft-login
          snapcraft login --with /tmp/snapcraft-login
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}

      - name: Upload and release snap
        if: steps.check_snap.outputs.skip == 'false'
        run: |
          snapcraft upload *.snap --release=stable

  publish-homebrew:
    runs-on: macos-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Check if Homebrew formula exists
        id: check_homebrew
        run: |
          if curl -f "https://formulae.brew.sh/api/formula/contextlite.json" | grep -q "${{ steps.version.outputs.version }}" 2>/dev/null; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… Homebrew formula already has this version, skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ Homebrew formula not found or different version, proceeding"
          fi

      - name: Get checksums from GitHub API
        if: steps.check_homebrew.outputs.skip == 'false'
        run: |
          # Get checksums directly from GitHub API (pre-computed)
          RELEASE_DATA=$(curl -s "https://api.github.com/repos/Michael-A-Kuykendall/contextlite/releases/tags/v${{ steps.version.outputs.version }}")
          AMD64_SHA=$(echo "$RELEASE_DATA" | grep -A2 "darwin-amd64.tar.gz" | grep '"digest"' | sed 's/.*sha256:\([^"]*\)".*/\1/')
          ARM64_SHA=$(echo "$RELEASE_DATA" | grep -A2 "darwin-arm64.tar.gz" | grep '"digest"' | sed 's/.*sha256:\([^"]*\)".*/\1/')
          echo "AMD64_SHA=$AMD64_SHA" >> $GITHUB_ENV
          echo "ARM64_SHA=$ARM64_SHA" >> $GITHUB_ENV
          echo "âœ… AMD64 SHA: $AMD64_SHA"
          echo "âœ… ARM64 SHA: $ARM64_SHA"

      - name: Create/update formula in repository
        if: steps.check_homebrew.outputs.skip == 'false'
        run: |
          # Update the formula in our repository with current version and checksums
          cp homebrew/contextlite.rb homebrew/contextlite.rb.tmp
          
          # Update version and checksums in our repository formula
          sed -i '' 's/v[0-9]\+\.[0-9]\+\.[0-9]\+/v${{ steps.version.outputs.version }}/g' homebrew/contextlite.rb.tmp
          sed -i '' 's/1\.[0-9]\+\.[0-9]\+/${{ steps.version.outputs.version }}/g' homebrew/contextlite.rb.tmp
          sed -i '' "s/YOUR_SHA256_CHECKSUM_HERE/$AMD64_SHA/" homebrew/contextlite.rb.tmp
          sed -i '' "s/YOUR_SHA256_AMD64_HERE/$AMD64_SHA/" homebrew/contextlite.rb.tmp
          sed -i '' "s/YOUR_SHA256_ARM64_HERE/$ARM64_SHA/" homebrew/contextlite.rb.tmp
          
          # Replace the original with updated version
          mv homebrew/contextlite.rb.tmp homebrew/contextlite.rb

      - name: Commit updated formula to repository
        if: steps.check_homebrew.outputs.skip == 'false'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add homebrew/contextlite.rb
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Homebrew formula for v${{ steps.version.outputs.version }}"
            git push origin HEAD:main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-scoop:
    runs-on: windows-latest
    if: false  # Disabled - missing SCOOP_GITHUB_TOKEN
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Update Scoop manifest
        shell: bash
        run: |
          cp dist/scoop/contextlite.json scoop-manifest.json
          sed -i "s/0\.0\.1-next/${{ steps.version.outputs.version }}/" scoop-manifest.json
          sed -i "s/v0\.0\.0/v${{ steps.version.outputs.version }}/" scoop-manifest.json
          sed -i "s/contextlite_Windows_x86_64.zip/contextlite-${{ steps.version.outputs.version }}-windows-amd64.zip/" scoop-manifest.json
          sed -i "s/contextlite_Windows_arm64.zip/contextlite-${{ steps.version.outputs.version }}-windows-arm64.zip/" scoop-manifest.json

      - name: Submit to Scoop bucket
        shell: bash
        run: |
          git clone https://github.com/ScoopInstaller/Main.git scoop-main
          cp scoop-manifest.json scoop-main/bucket/contextlite.json
          cd scoop-main
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git checkout -b contextlite-${{ steps.version.outputs.version }}
          git add bucket/contextlite.json
          git commit -m "contextlite: Update to ${{ steps.version.outputs.version }}"
          git remote add fork https://github.com/${{ github.actor }}/Main.git
          git push fork contextlite-${{ steps.version.outputs.version }}

  publish-winget:
    runs-on: windows-latest
    if: false  # Disabled - missing WINGET_GITHUB_TOKEN
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Submit to winget
        uses: vedantmgoyal2009/winget-releaser@v2
        with:
          identifier: Michael-A-Kuykendall.ContextLite
          token: ${{ secrets.GITHUB_TOKEN }}

  publish-aur:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Check if AUR package exists
        id: check_aur
        run: |
          if curl -f "https://aur.archlinux.org/rpc/?v=5&type=info&arg=contextlite" | grep -q "${{ steps.version.outputs.version }}" 2>/dev/null; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… AUR package already has this version, skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ AUR package not found or different version, proceeding"
          fi

      - name: Create AUR package
        if: steps.check_aur.outputs.skip == 'false'
        run: |
          mkdir aur-package
          cat > aur-package/PKGBUILD << 'EOF'
          pkgname=contextlite
          pkgver=${{ steps.version.outputs.version }}
          pkgrel=1
          pkgdesc="Ultra-fast context engine for retrieval and AI applications"
          arch=('x86_64')
          url="https://contextlite.com"
          license=('MIT')
          depends=()
          source=("https://github.com/Michael-A-Kuykendall/contextlite/releases/download/v${pkgver}/contextlite-${pkgver}-linux-amd64.tar.gz")
          sha256sums=('SKIP')

          package() {
              install -Dm755 "${srcdir}/contextlite" "${pkgdir}/usr/bin/contextlite"
          }
          EOF

      - name: Publish to AUR
        if: steps.check_aur.outputs.skip == 'false'
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
        with:
          pkgname: contextlite
          pkgbuild: aur-package/PKGBUILD
          commit_username: ${{ github.actor }}
          commit_email: ${{ github.actor }}@users.noreply.github.com
          ssh_private_key: ${{ secrets.AUR_SSH_KEY }}

  publish-flathub:
    runs-on: ubuntu-latest
    if: false  # Disabled - missing FLATHUB_TOKEN
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Flatpak manifest
        run: |
          mkdir -p flathub
          cat > flathub/com.contextlite.ContextLite.yml << 'EOF'
          app-id: com.contextlite.ContextLite
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: contextlite
          finish-args:
            - --share=network
            - --filesystem=home
          modules:
            - name: contextlite
              buildsystem: simple
              build-commands:
                - install -D contextlite /app/bin/contextlite
              sources:
                - type: archive
                  url: https://github.com/Michael-A-Kuykendall/contextlite/releases/download/v${{ steps.version.outputs.version }}/contextlite-${{ steps.version.outputs.version }}-linux-amd64.tar.gz
          EOF

      - name: Submit to Flathub
        run: |
          git clone https://github.com/flathub/flathub.git
          cp flathub/com.contextlite.ContextLite.yml flathub/
          cd flathub
          git checkout -b contextlite-${{ steps.version.outputs.version }}
          git add com.contextlite.ContextLite.yml
          git commit -m "Add ContextLite ${{ steps.version.outputs.version }}"

  publish-github-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare GitHub Package
        run: |
          cp -r npm-wrapper github-package
          cd github-package
          # Update package name for GitHub Packages
          sed -i 's/"name": "contextlite"/"name": "@michael-a-kuykendall\/contextlite"/' package.json
          # Update version
          sed -i 's/"version": ".*"/"version": "${{ steps.version.outputs.version }}"/' package.json
          
      - name: Publish to GitHub Packages
        run: |
          cd github-package
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-nix:
    runs-on: ubuntu-latest
    if: false  # Disabled - missing NIXPKGS_GITHUB_TOKEN
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Nix package
        run: |
          mkdir nix-package
          cat > nix-package/default.nix << 'EOF'
          { lib, stdenv, fetchurl }:

          stdenv.mkDerivation rec {
            pname = "contextlite";
            version = "${{ steps.version.outputs.version }}";

            src = fetchurl {
              url = "https://github.com/Michael-A-Kuykendall/contextlite/releases/download/v${version}/contextlite-${version}-linux-amd64.tar.gz";
              sha256 = "SKIP";
            };

            installPhase = ''
              mkdir -p $out/bin
              cp contextlite $out/bin/contextlite
            '';

            meta = with lib; {
              description = "Ultra-fast context engine for retrieval and AI applications";
              homepage = "https://contextlite.com";
              license = licenses.mit;
              platforms = platforms.linux;
            };
          }
          EOF

      - name: Submit to nixpkgs
        run: |
          git clone https://github.com/NixOS/nixpkgs.git
          mkdir -p nixpkgs/pkgs/applications/misc/contextlite
          cp nix-package/default.nix nixpkgs/pkgs/applications/misc/contextlite/
          cd nixpkgs
          git checkout -b contextlite-${{ steps.version.outputs.version }}
          git add pkgs/applications/misc/contextlite/
          git commit -m "contextlite: init at ${{ steps.version.outputs.version }}"
