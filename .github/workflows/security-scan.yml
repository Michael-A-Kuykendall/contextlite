name: Security Scan

on:
  push:
    branches: [ main, public-release-prep ]
  pull_request:
    branches: [ main, public-release-prep ]
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'

jobs:
  vulnerability-scan:
    name: Vulnerability Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        
    - name: Install govulncheck
      run: go install golang.org/x/vuln/cmd/govulncheck@latest
      
    - name: Run govulncheck
      run: |
        echo "🔍 Running govulncheck for Go vulnerability scanning..."
        govulncheck ./...
        
    - name: Install nancy (alternative scanner)
      run: |
        curl -L -o nancy https://github.com/sonatypecommunity/nancy/releases/download/v1.0.42/nancy-v1.0.42-linux-amd64
        chmod +x nancy
        sudo mv nancy /usr/local/bin/
        
    - name: Run nancy dependency scan
      run: |
        echo "🔍 Running nancy for dependency vulnerability scanning..."
        go list -json -m all | nancy sleuth
        
    - name: Run go mod audit
      run: |
        echo "🔍 Checking for outdated dependencies..."
        go list -u -m all
        
    - name: Create security report
      if: always()
      run: |
        echo "# Security Scan Report" > security-report.md
        echo "**Date:** $(date)" >> security-report.md
        echo "**Commit:** ${{ github.sha }}" >> security-report.md
        echo "" >> security-report.md
        echo "## Vulnerability Scan Results" >> security-report.md
        echo "- govulncheck: $(if govulncheck ./... > /dev/null 2>&1; then echo '✅ PASS'; else echo '❌ VULNERABILITIES FOUND'; fi)" >> security-report.md
        echo "- nancy: $(if go list -json -m all | nancy sleuth > /dev/null 2>&1; then echo '✅ PASS'; else echo '❌ VULNERABILITIES FOUND'; fi)" >> security-report.md
        
    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        retention-days: 30
